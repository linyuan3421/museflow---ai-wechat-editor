# MuseFlow RAG 优化方案

**项目**: AI 主题生成性能优化  
**日期**: 2025-01-31  
**预期收益**: Token 成本降低 80%，生成精度提升

---

## 一、问题与目标

### 当前问题
- **成本高**: 系统提示词 4000+ tokens，单次 API 调用约 $0.02
- **精度低**: "莫兰迪色"生成近似值而非标准色值 `#BFA89A`
- **扩展难**: 添加新知识 = 提示词更长 = 成本更高

### 优化目标
- Token 使用量降低 80%（4000 → 800）
- AI 使用精确设计数据（HEX 色值、CSS 代码）
- 知识库扩展零成本（本地存储）

---

## 二、解决方案

### 核心思路：RAG（检索增强生成）

将固定知识从提示词分离 → 用户查询时动态检索 → 注入相关知识 → 发送给 AI

```
用户输入 "莫兰迪咖啡馆" → 检索 top-3 相关知识 → 构建增强提示词 → AI 生成
```

### 技术选型：Orama.js

| 对比项 | Orama.js | Firebase | Pinecone |
|--------|----------|----------|----------|
| 成本 | **$0** | 按量计费 | 按量计费 |
| 速度 | **<10ms** | 100-300ms | 200-500ms |
| 隐私 | **100% 本地** | 上传云端 | 上传云端 |
| 检索质量 | 关键词匹配 | 向量语义 | 向量语义 |

**选择理由**：
- 设计领域术语标准（"莫兰迪""油画质感"），关键词匹配已足够
- 零成本、零延迟、零隐私风险
- 包体积仅 2kb

---

## 三、实施方案

### 1. 架构设计

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│ 用户输入    │ ──▶ │ RAG 服务     │ ──▶ │ AI API      │
│ "莫兰迪咖啡馆" │     │ (Orama.js)  │     │ 生成主题    │
└─────────────┘     └──────────────┘     └─────────────┘
                          │
                          ▼
                   ┌──────────────┐
                   │ 知识库 (JSON) │
                   │ 50+ 设计条目  │
                   └──────────────┘
```

### 2. 核心模块

**模块 A: 知识库** (`data/knowledge-base.json`)
- 50+ 条目，分 6 类：配色、纹理、场景、风格、技法、情感
- 每条含：关键词、名称、描述、数据（精确 HEX、CSS 代码等）

**模块 B: RAG 服务** (`services/knowledgeService.ts`)
```typescript
- initKnowledgeDB()      // 初始化数据库
- retrieveKnowledge()    // 语义检索
- enhancePrompt()        // 构建增强提示词
```

**模块 C: AI 服务集成** (`services/aiService.ts`)
```typescript
// 原代码
const prompt = THEME_SYSTEM_PROMPT  // 4000 tokens

// 新代码
const prompt = await enhancePromptWithKnowledge(THEME_SYSTEM_PROMPT, userInput)  // 1000 tokens
```

### 3. 实施步骤

| 步骤 | 任务 | 预计时间 |
|------|------|----------|
| 1 | 创建知识库 JSON（50+ 条目） | 2 小时 |
| 2 | 实现 knowledgeService.ts | 1 小时 |
| 3 | 集成到 aiService.ts | 30 分钟 |
| 4 | 测试验证 | 1 小时 |
| **总计** | | **4.5 小时** |

---

## 四、预期效果

| 指标 | 优化前 | 优化后 | 改进 |
|------|--------|--------|------|
| 提示词长度 | 4000 tokens | 1000 tokens | ↓ 75% |
| API 成本 | $0.02/次 | $0.005/次 | ↓ 75% |
| 莫兰迪色精度 | 近似 RGB | 精确 HEX | ✓ |
| 知识扩展成本 | +50 tokens/条 | 0 | ✓ |

---

## 五、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 关键词匹配质量不足 | 检索不准确 | 在 keywords 字段预置丰富同义词 |
| 未来需语义检索 | 需重构 | Orama.js 支持 OpenAI Embeddings 插件，无缝升级 |

---

## 六、后续优化方向

1. **知识库扩展**: 增加更多风格、场景条目
2. **向量检索升级**: 接入 OpenAI Embeddings（月成本 <$1）
3. **用户反馈学习**: 记录用户选择，优化检索权重

---

**结论**: 采用 Orama.js 实现 RAG，可在 4.5 小时内完成优化，降低 75% API 成本，提升生成精度。
